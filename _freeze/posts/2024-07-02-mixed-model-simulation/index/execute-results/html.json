{
  "hash": "1ec15ddf281e0bd89b1d6db5a0e90862",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Mixed model simulation\nauthor: Shaun Nielsen\ndate: '2024-07-02'\ncategories: [statistics,simulation]\nknitr:\n  opts_chunk: \n    fig.align: \"center\"\n---\n\n\nI have started to believe that a good part of understanding the process of a particular statistical model involves being able to set up a simulation of it. Here we do a simulation of data expected from a fish gut microbiota pilot study that I was involved in\n\n<!--more-->\n\n## Let's go\n\nWhile we obtain abundance data on many different microbes at once (a community profile) in such studies, the first step is to understand what we can do with just one. This means this approach is applicable to each microbe separately and does not examine the data at community level.\n\nIn this simulation, there are 4 gut locations (mouth, foregut, midgut and hindgut) examined from 10 fish (A to J).\n\nThe model is:\n\n$$Y_{abundance} = beta1_{gut.location} + sigma1_{fish} + sigma2_{unexplained}$$\n\n## Packages\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(lme4)\nlibrary(emmeans)\n```\n:::\n\n\n## Building the data set\n\nThere are 4 gut locations and 10 fish, thus there are 40 \\* 10 rows required.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfish_data <-\n  expand.grid(\n    gut_location = c(\"mouth\", \"foregut\", \"midgut\",\"hindgut\"),\n    fish_id = LETTERS[1:10]\n  ) |>\n  tibble::as_tibble()\n\nfish_data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 40 × 2\n   gut_location fish_id\n   <fct>        <fct>  \n 1 mouth        A      \n 2 foregut      A      \n 3 midgut       A      \n 4 hindgut      A      \n 5 mouth        B      \n 6 foregut      B      \n 7 midgut       B      \n 8 hindgut      B      \n 9 mouth        C      \n10 foregut      C      \n# ℹ 30 more rows\n```\n\n\n:::\n:::\n\n\n## Define parameters\n\nLet's assume these proportion trends and that there are about 200 individuals. This gives us the deterministic part of the model.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ngut_location_proportion <-\n  c(\"mouth\" = 0.01, \n    \"foregut\" = 0.5, \n    \"midgut\" = 0.35, \n    \"hindgut\" = 0.10\n  )\n\ngut_location_means <- 200 * gut_location_proportion\n  \ngut_location_means\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mouth foregut  midgut hindgut \n      2     100      70      20 \n```\n\n\n:::\n:::\n\n\nNext we define the variability of fish individuals and unexplained variation.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(1010)\n\nfish_variation <-\n  rnorm(10, sd = 15) |>\n  round(digits = 0) |>\n  setNames(unique(fish_data$fish_id))\n\nfish_variation\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  A   B   C   D   E   F   G   H   I   J \n  2 -13  20   6  -4  20  29 -35  -9  -8 \n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nresidual_variation <-\n  rnorm(n = nrow(fish_data), sd = 5) |> \n  round(0)\n\nresidual_variation\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] -1 -4 -7  0  4 -4 -4  1 -5 -5  0  4 -5  2 -3  4 -2 -5 -1 -9 -5 10 -1  2 -5\n[26]  2 -1 -2 -3 -5 -2  2  0  3 -3  1  2 -3  2  7\n```\n\n\n:::\n:::\n\n\n## Simulating the counts\n\nThen we use the above to create observed counts\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(1010)\n\nfish_data_build <-\n  fish_data |> \n  dplyr::mutate(\n    location_count = gut_location_means[gut_location],\n    fish_variation = fish_variation[fish_id],\n    residual_variation = residual_variation,\n    observed_count = location_count + fish_variation + residual_variation,\n    observed_count = ifelse(observed_count < 0, 0, observed_count)\n  )\n\nfish_data_build\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 40 × 6\n   gut_location fish_id location_count fish_variation residual_variation\n   <fct>        <fct>            <dbl>          <dbl>              <dbl>\n 1 mouth        A                    2              2                 -1\n 2 foregut      A                  100              2                 -4\n 3 midgut       A                   70              2                 -7\n 4 hindgut      A                   20              2                  0\n 5 mouth        B                    2            -13                  4\n 6 foregut      B                  100            -13                 -4\n 7 midgut       B                   70            -13                 -4\n 8 hindgut      B                   20            -13                  1\n 9 mouth        C                    2             20                 -5\n10 foregut      C                  100             20                 -5\n# ℹ 30 more rows\n# ℹ 1 more variable: observed_count <dbl>\n```\n\n\n:::\n:::\n\n\nAnd lastly, clean up the data\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfish_data_final <-\n  fish_data_build |>\n  dplyr::select(gut_location, fish_id, observed_count)\n\nfish_data_final\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 40 × 3\n   gut_location fish_id observed_count\n   <fct>        <fct>            <dbl>\n 1 mouth        A                    3\n 2 foregut      A                   98\n 3 midgut       A                   65\n 4 hindgut      A                   22\n 5 mouth        B                    0\n 6 foregut      B                   83\n 7 midgut       B                   53\n 8 hindgut      B                    8\n 9 mouth        C                   17\n10 foregut      C                  115\n# ℹ 30 more rows\n```\n\n\n:::\n:::\n\n\n## Data exploration\n\nCounts by fish individuals\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfish_data_final |>\n  ggplot(aes(x = gut_location, y = observed_count, group = fish_id)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nIn another way\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfish_data_final |>\n  ggplot(aes(x = gut_location, y = observed_count, group = fish_id)) +\n  geom_line() +\n  geom_point() +\n  facet_wrap(vars(fish_id), nrow = 2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nHand calculating parameters\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfish_data_final |>\n  dplyr::group_by(gut_location) |>\n  dplyr::summarise(\n    mean_count = mean(observed_count)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 2\n  gut_location mean_count\n  <fct>             <dbl>\n1 mouth               6.6\n2 foregut            99.9\n3 midgut             68.8\n4 hindgut            23.1\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfish_data_final |>\n  dplyr::group_by(fish_id) |>\n  dplyr::summarise(\n    mean_count = mean(observed_count)\n  ) |>\n  dplyr::ungroup() |>\n  dplyr::summarise(\n    sd_count = sd(mean_count)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n  sd_count\n     <dbl>\n1     16.5\n```\n\n\n:::\n:::\n\n\n\n## Modelling\n\nWe fit the model like so\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit1 <- lmer(observed_count ~ gut_location + (1|fish_id), data = fish_data_final)\n\nplot(fit1, pch = 19)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nAnd obtain a model summary\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit1_summary <- summary(fit1)\nfit1_summary\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: observed_count ~ gut_location + (1 | fish_id)\n   Data: fish_data_final\n\nREML criterion at convergence: 279.4\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-2.10601 -0.40453  0.02645  0.36144  2.65347 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n fish_id  (Intercept) 259.93   16.122  \n Residual              48.95    6.997  \nNumber of obs: 40, groups:  fish_id, 10\n\nFixed effects:\n                    Estimate Std. Error t value\n(Intercept)            6.600      5.558   1.188\ngut_locationforegut   93.300      3.129  29.818\ngut_locationmidgut    62.200      3.129  19.879\ngut_locationhindgut   16.500      3.129   5.273\n\nCorrelation of Fixed Effects:\n            (Intr) gt_lctnf gt_lctnm\ngt_lctnfrgt -0.281                  \ngt_lctnmdgt -0.281  0.500           \ngt_lctnhndg -0.281  0.500    0.500  \n```\n\n\n:::\n:::\n\n\nAnd we obtain the values we used for the data simulation\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit1_summary$coefficients\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                    Estimate Std. Error   t value\n(Intercept)              6.6   5.557727  1.187536\ngut_locationforegut     93.3   3.128957 29.818245\ngut_locationmidgut      62.2   3.128957 19.878830\ngut_locationhindgut     16.5   3.128957  5.273323\n```\n\n\n:::\n\n```{.r .cell-code}\nfit1_summary$varcor\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Groups   Name        Std.Dev.\n fish_id  (Intercept) 16.1224 \n Residual              6.9966 \n```\n\n\n:::\n:::\n\n\nLastly, a final plot ...\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit1_means <- \n  emmeans::emmeans(fit1, specs = 'gut_location') |>\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCannot use mode = \"kenward-roger\" because *pbkrtest* package is not installed\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfish_data_final |>\n  ggplot(aes(x = gut_location, y = observed_count)) +\n  geom_jitter(height = 0, width = 0.15) +\n  geom_point(data = fit1_means,\n             mapping = aes(y = emmean), \n             color = 'red', size = 4, shape = 'cross') +\n  geom_line(data = fit1_means,\n            mapping = aes(y = emmean, group = 1), \n            color = 'red') +\n  geom_errorbar(data = fit1_means, \n                mapping = aes(y = NULL, ymax = upper.CL, ymin = lower.CL), \n                color = 'red',\n                width = 0.1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){fig-align='center' width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}